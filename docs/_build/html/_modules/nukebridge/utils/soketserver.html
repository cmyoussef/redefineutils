<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nukebridge.utils.soketserver &mdash; NukeBridge 1.0.5 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=d55fa986"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            NukeBridge
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">nukebridge</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NukeBridge</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../nukebridge.html">nukebridge</a></li>
      <li class="breadcrumb-item active">nukebridge.utils.soketserver</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for nukebridge.utils.soketserver</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the implementation of a socket server and client for a Nuke node.</span>

<span class="sd">The module is divided into three main classes:</span>

<span class="sd">1. SingletonMeta: A metaclass that ensures only one instance of a class is created for each unique port.</span>

<span class="sd">2. ServerClientBase: A base class that provides a basic structure for server and client operations. It includes methods for closing connections and the server, and finding an available port. It also includes methods for encoding and decoding data, and receiving data from a client.</span>

<span class="sd">3. SocketServer: A class that inherits from ServerClientBase and uses SingletonMeta as its metaclass. This class is responsible for creating a server that can accept multiple client connections and handle data transmission between the server and the clients.</span>

<span class="sd">4. SocketClient: A class that inherits from ServerClientBase. This class is responsible for creating a client that can connect to a server, send data to the server, and receive data from the server.</span>

<span class="sd">The module also includes a main function that initializes a SocketServer instance, accepts a client connection, and starts the server.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">select</span>

<span class="kn">from</span> <span class="nn">nukebridge.utils.logger</span> <span class="kn">import</span> <span class="n">logger_level</span><span class="p">,</span> <span class="n">logger</span>

<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logger_level</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">nukebridge.utils.logger</span> <span class="kn">import</span> <span class="n">logger</span>


<div class="viewcode-block" id="SingletonMeta">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SingletonMeta">[docs]</a>
<span class="k">class</span> <span class="nc">SingletonMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SingletonMeta metaclass.</span>

<span class="sd">    This metaclass ensures that only one instance of a class is created for each unique port. It stores the instances in a dictionary where the keys are the ports and the values are the instances.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _instances (dict): A dictionary to store the instances of the classes that use this metaclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new instance or returns an existing one.</span>

<span class="sd">        This method overrides the default __call__ method. It checks if an instance already exists for the given port. If it does, it returns the existing instance. If it doesn&#39;t, it creates a new instance and stores it in the _instances dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Variable length argument list.</span>
<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: The instance of the class that uses this metaclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">port</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">port</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="ServerClientBase">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.ServerClientBase">[docs]</a>
<span class="k">class</span> <span class="nc">ServerClientBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for server and client operations.</span>

<span class="sd">    This class provides a basic structure for server and client operations. It includes methods for closing connections and the server, and finding an available port. It also includes methods for encoding and decoding data, and receiving data from a client.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        client_threads (dict): A dictionary to store client threads.</span>
<span class="sd">        client_connections (dict): A dictionary to store client connections.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the ServerClientBase with empty dictionaries for client threads and connections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Stores client threads and connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_threads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_connections</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="ServerClientBase.close_connection">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.ServerClientBase.close_connection">[docs]</a>
    <span class="k">def</span> <span class="nf">close_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the connection with the client at the given address.</span>

<span class="sd">        This method should be overridden in a subclass.</span>

<span class="sd">        Args:</span>
<span class="sd">            addr (tuple): The address of the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ServerClientBase.close_server">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.ServerClientBase.close_server">[docs]</a>
    <span class="k">def</span> <span class="nf">close_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the server.</span>

<span class="sd">        This method should be overridden in a subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ServerClientBase.find_available_port">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.ServerClientBase.find_available_port">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_available_port</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds an available port.</span>

<span class="sd">        This method creates a temporary socket, binds it to an available port chosen by the OS, retrieves the chosen port, and then closes the temporary socket.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The available port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a temporary socket with the correct arguments</span>
        <span class="n">temp_sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c1"># Enable the SO_REUSEADDR option</span>
        <span class="n">temp_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Bind to an available port chosen by the OS</span>
        <span class="n">temp_sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># Retrieve the chosen port</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">temp_sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Close the temporary socket</span>
        <span class="n">temp_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># Return the found port</span>
        <span class="k">return</span> <span class="n">port</span></div>


<div class="viewcode-block" id="ServerClientBase.encode_data">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.ServerClientBase.encode_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">encode_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encodes the data into a serialized format.</span>

<span class="sd">        This method takes the data, serializes it using pickle, calculates the size of the serialized data, and then returns the encoded data in a specific format.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (object): The data to be encoded.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: The encoded data in the format b&#39;data::&#39; + payload_size + serialized_data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">serialized_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">payload_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">serialized_data</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;data::&#39;</span> <span class="o">+</span> <span class="n">payload_size</span> <span class="o">+</span> <span class="n">serialized_data</span></div>


<div class="viewcode-block" id="ServerClientBase.decode_data">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.ServerClientBase.decode_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">decode_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_buffer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decodes the data received from the buffer.</span>

<span class="sd">        This method continuously checks the data buffer for new data. If new data is found, it is extracted, decoded, and returned. If the complete data is not received yet, the method breaks the loop and returns None.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_buffer (bytes): The buffer containing the data to be decoded.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: The decoded data if the complete data is received, otherwise None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If an error occurred while decoding the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">payload_size</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Check for the header and split the buffer accordingly</span>
            <span class="k">if</span> <span class="n">data_buffer</span> <span class="ow">and</span> <span class="sa">b</span><span class="s1">&#39;::&#39;</span> <span class="ow">in</span> <span class="n">data_buffer</span> <span class="ow">and</span> <span class="n">payload_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header</span><span class="p">,</span> <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">data_buffer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
                    <span class="c1"># Extract payload size and update the buffer</span>
                    <span class="n">payload_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;!I&#39;</span><span class="p">,</span> <span class="n">data_buffer</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">data_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>

            <span class="c1"># Accumulate the payload data</span>
            <span class="k">if</span> <span class="n">payload_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">payload_data</span> <span class="o">+=</span> <span class="n">data_buffer</span>
                <span class="n">data_buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

                <span class="c1"># Check if the complete payload is received</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">payload_size</span><span class="p">:</span>
                    <span class="n">actual_data</span> <span class="o">=</span> <span class="n">payload_data</span><span class="p">[:</span><span class="n">payload_size</span><span class="p">]</span>

                    <span class="c1"># Deserialize the actual data</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">actual_data</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">decoded_data</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># Handle deserialization error</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while decoding data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># If no complete data is received yet, break the loop</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_buffer</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Return None or raise an error if the complete data is not received</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ServerClientBase.receive_data">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.ServerClientBase.receive_data">[docs]</a>
    <span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_response_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receives data from a client, decodes it, and optionally handles it.</span>

<span class="sd">        This method continuously receives data from a client until the client closes the connection or sends a &#39;quit&#39; command. The received data is decoded and, if a data handler is provided, the decoded data is passed to the handler. If the handler returns a response and return_response_data is True, the response is sent back to the client.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn (socket): The client&#39;s socket connection.</span>
<span class="sd">            addr (tuple): The client&#39;s address.</span>
<span class="sd">            data_handler (callable, optional): A function to handle the decoded data. Defaults to None.</span>
<span class="sd">            return_response_data (bool, optional): Whether to send the handler&#39;s response back to the client. Defaults to False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConnectionResetError: If the client closes the connection.</span>
<span class="sd">            Exception: If an unexpected error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inside receive_data for </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">data_buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">payload_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">payload_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">data_handler</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">packet</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">packet</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">data_buffer</span> <span class="o">+=</span> <span class="n">packet</span>

                <span class="k">while</span> <span class="sa">b</span><span class="s1">&#39;::&#39;</span> <span class="ow">in</span> <span class="n">data_buffer</span> <span class="ow">and</span> <span class="n">payload_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">header</span><span class="p">,</span> <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">data_buffer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;command&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">data_buffer</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;quit&#39;</span><span class="p">:</span>
                            <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ack&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close_server</span><span class="p">()</span>
                            <span class="k">return</span>

                    <span class="k">elif</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
                        <span class="n">payload_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;!I&#39;</span><span class="p">,</span> <span class="n">data_buffer</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">data_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>

                <span class="k">if</span> <span class="n">payload_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">payload_data</span> <span class="o">+=</span> <span class="n">data_buffer</span>
                    <span class="n">data_buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">payload_size</span><span class="p">:</span>
                        <span class="n">actual_data</span> <span class="o">=</span> <span class="n">payload_data</span><span class="p">[:</span><span class="n">payload_size</span><span class="p">]</span>
                        <span class="n">decoded_data</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1"># First try block to check data loading</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">actual_data</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while decoding data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="c1"># Second try block to check data_handler</span>
                        <span class="k">if</span> <span class="n">decoded_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">response_data</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
                                    <span class="n">response_data</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">)</span>

                                <span class="c1"># Sending an acknowledgment back to the client</span>
                                <span class="k">if</span> <span class="n">response_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">return_response_data</span><span class="p">:</span>
                                    <span class="n">encoded_response</span> <span class="o">=</span> <span class="n">SocketServer</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending encoded_response type:</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">encoded_response</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ack&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred in data_handler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">tb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">payload_data</span><span class="p">[</span><span class="n">payload_size</span><span class="p">:]</span>
                        <span class="n">payload_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                        <span class="n">payload_size</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">except</span> <span class="ne">ConnectionResetError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Connection was closed by the client.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span></div>
</div>


        <span class="c1"># Clean up and close the connection</span>


<div class="viewcode-block" id="SocketServer">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketServer">[docs]</a>
<span class="k">class</span> <span class="nc">SocketServer</span><span class="p">(</span><span class="n">ServerClientBase</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">SingletonMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SocketServer class that inherits from ServerClientBase and uses SingletonMeta as its metaclass.</span>

<span class="sd">    This class is responsible for creating a server that can accept multiple client connections and handle data transmission between the server and the clients. It uses the Singleton design pattern to ensure that only one instance of the server is created for each unique port.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        client_threads (dict): A dictionary to store client threads.</span>
<span class="sd">        client_connections (dict): A dictionary to store client connections.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SocketServer.get_instances">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketServer.get_instances">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_instances</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a copy of the dictionary containing all initialized instances</span>
<span class="sd">        of the SocketServer class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary where the keys are the ports and the values are the instances of the SocketServer class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the SocketServer with the given port, data handler, and host.</span>

<span class="sd">        This method initializes the SocketServer by calling the superclass&#39;s initializer and setting the port, data handler, and host. If no port is provided, it defaults to None. If no data handler is provided, it defaults to None. If no host is provided, it defaults to &quot;localhost&quot;.</span>

<span class="sd">        Args:</span>
<span class="sd">            port (int, optional): The port number for the server to listen on. Defaults to None.</span>
<span class="sd">            data_handler (callable, optional): A function to handle the decoded data. Defaults to None.</span>
<span class="sd">            host (str, optional): The hostname to bind the server to. Defaults to &quot;localhost&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_handler</span> <span class="o">=</span> <span class="n">data_handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="c1"># if port:</span>
        <span class="c1">#     self.port = port</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.port = self.find_available_port()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">handler_logger</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;, DataHandler:</span><span class="si">{</span><span class="n">data_handler</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">data_handler</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server created on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">, Host:</span><span class="si">{</span><span class="n">host</span><span class="si">}{</span><span class="n">handler_logger</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SocketServer.start_accepting_clients">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketServer.start_accepting_clients">[docs]</a>
    <span class="k">def</span> <span class="nf">start_accepting_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_response_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts accepting client connections.</span>

<span class="sd">        This method starts a new thread that continuously accepts client connections. For each client connection, it starts a new thread that receives data from the client.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_handler (callable, optional): A function to handle the decoded data. Defaults to None.</span>
<span class="sd">            return_response_data (bool, optional): Whether to send the handler&#39;s response back to the client. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server starting on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data_handler</span> <span class="o">=</span> <span class="n">data_handler</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_handler</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accept_client</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">data_handler</span><span class="p">,</span> <span class="n">return_response_data</span><span class="p">,))</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting to accept clients. on </span><span class="si">{</span><span class="n">thread</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SocketServer.accept_client">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketServer.accept_client">[docs]</a>
    <span class="k">def</span> <span class="nf">accept_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_response_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accepts a client connection and starts a new thread to receive data from the client.</span>

<span class="sd">        This method continuously accepts client connections until the server is closed. For each client connection, it starts a new thread that receives data from the client.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_handler (callable, optional): A function to handle the decoded data. Defaults to None.</span>
<span class="sd">            return_response_data (bool, optional): Whether to send the handler&#39;s response back to the client. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Inside accept_client.&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accepted connection from </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="c1"># Store the client connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_connections</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>

            <span class="c1"># Start a new thread for each client</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">receive_data</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data_handler</span><span class="p">,</span> <span class="n">return_response_data</span><span class="p">,))</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Store the thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_threads</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">thread</span></div>


<div class="viewcode-block" id="SocketServer.send_to_all_clients">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketServer.send_to_all_clients">[docs]</a>
    <span class="k">def</span> <span class="nf">send_to_all_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends data to all connected clients.</span>

<span class="sd">        This method encodes the data and sends it to all connected clients.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (object): The data to be sent to the clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">encoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data sent to client at </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send data to client at </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SocketServer.close_connection">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketServer.close_connection">[docs]</a>
    <span class="k">def</span> <span class="nf">close_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the connection with the client at the given address.</span>

<span class="sd">        This method closes the connection with the client and removes the client&#39;s connection and thread from the dictionaries.</span>

<span class="sd">        Args:</span>
<span class="sd">            addr (tuple): The address of the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing connection with </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_connections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_connections</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_connections</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_threads</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server is closed </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SocketServer.close_server">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketServer.close_server">[docs]</a>
    <span class="k">def</span> <span class="nf">close_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes all client connections and then shuts down the server.</span>

<span class="sd">        This method closes all client connections, clears the connections and threads dictionaries, and then shuts down and closes the server socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Close all client connections</span>
        <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed connection with client at </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing connection with client at </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Clear the connections and threads dictionaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_connections</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_threads</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Shut down and close the server socket if it&#39;s open</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error shutting down server socket: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server socket closed successfully.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing server socket: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SocketClient">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketClient">[docs]</a>
<span class="k">class</span> <span class="nc">SocketClient</span><span class="p">(</span><span class="n">ServerClientBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SocketClient class that inherits from ServerClientBase.</span>

<span class="sd">    This class is responsible for creating a client that can connect to a server, send data to the server, and receive data from the server.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        is_client_connected (bool): A flag indicating whether the client is connected to the server.</span>
<span class="sd">        thread_list (list): A list to store threads.</span>
<span class="sd">        node_obj (object): Nuke node class instance, for example SimpleNode().</span>
<span class="sd">        gizmo (object): Nuke object for the gizmo that inside hte node.</span>
<span class="sd">        client (socket): The client&#39;s socket connection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the SocketClient with the given node object.</span>

<span class="sd">        Args:</span>
<span class="sd">            node_obj (object): Nuke node class instance, for example SimpleNode().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_client_connected</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span> <span class="o">=</span> <span class="n">node_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gizmo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">gizmo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<div class="viewcode-block" id="SocketClient.ensure_server_connection">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketClient.ensure_server_connection">[docs]</a>
    <span class="k">def</span> <span class="nf">ensure_server_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures that the client is connected to the server.</span>

<span class="sd">        This method checks if the server is running and if the client is connected to the server. If the server is not running, it starts the server. If the client is not connected, it attempts to reconnect to the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.write_input()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_server_running</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server is already running. Through port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting the server.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">on_interrupt</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">start_server</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_client_connected</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to connect to the server.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attempt_reconnect</span><span class="p">(</span><span class="n">start_sleep</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="SocketClient.send_data_and_wait_for_response">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketClient.send_data_and_wait_for_response">[docs]</a>
    <span class="k">def</span> <span class="nf">send_data_and_wait_for_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends data to the server and waits for a response.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (object): The data to send to the server.</span>
<span class="sd">            timeout (int, optional): The timeout in seconds for waiting for a response. Defaults to 600.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: The response received from the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sending data to server</span>
        <span class="c1"># try:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">SocketServer</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="c1"># except OSError:</span>
        <span class="c1">#     raise OSError(&quot;Server is not running&quot;)</span>
        <span class="c1"># Waiting for server&#39;s response</span>
        <span class="n">ready</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ready</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>  <span class="c1"># Adjust buffer size as needed</span>
            <span class="n">image_list</span> <span class="o">=</span> <span class="n">SocketServer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="c1"># # self.reload_read_nodes()</span>
            <span class="k">return</span> <span class="n">image_list</span></div>


<div class="viewcode-block" id="SocketClient.attempt_to_send">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketClient.attempt_to_send">[docs]</a>
    <span class="k">def</span> <span class="nf">attempt_to_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_to_send</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to send data to the server.</span>

<span class="sd">        This method tries to send data to the server. If an error occurs, it attempts to reconnect to the server and then tries to send the data again.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_to_send (object): The data to send to the server.</span>
<span class="sd">            timeout (int, optional): The timeout in seconds for waiting for a response. Defaults to 600.</span>
<span class="sd">        Returns:</span>
<span class="sd">            object: The response received from the server, or False if the data could not be sent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">try_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">try_count</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">try_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">try_count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send to the server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># self.client.sendall(SocketServer.encode_data())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;data_to_send: </span><span class="si">{</span><span class="n">data_to_send</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">rec_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data_and_wait_for_response</span><span class="p">(</span><span class="n">data_to_send</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;received : </span><span class="si">{</span><span class="n">rec_data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rec_data</span>
                <span class="c1"># break</span>

            <span class="k">except</span> <span class="ne">ConnectionResetError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ConnectionResetError trying ensure_server_connection at port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensure_server_connection</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;AttributeError trying ensure_server_connection at port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensure_server_connection</span><span class="p">()</span></div>


<div class="viewcode-block" id="SocketClient.is_server_running">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketClient.is_server_running">[docs]</a>
    <span class="k">def</span> <span class="nf">is_server_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the server is running.</span>

<span class="sd">        This method attempts to connect to the server&#39;s port to check if the server is running.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the server is running, otherwise False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="n">test_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SocketClient.connect_to_server">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketClient.connect_to_server">[docs]</a>
    <span class="k">def</span> <span class="nf">connect_to_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connects to the server.</span>

<span class="sd">        This method attempts to connect to the server. If the connection is successful, it sets the is_client_connected flag to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the connection is successful, otherwise False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;trying to connect to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully connected to server at port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Successfully connected to server at port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">ConnectionRefusedError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection to server at port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2"> refused.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while connecting: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SocketClient.attempt_reconnect">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketClient.attempt_reconnect">[docs]</a>
    <span class="k">def</span> <span class="nf">attempt_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_sleep</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to reconnect to the server.</span>

<span class="sd">        This method starts a new thread that attempts to reconnect to the server.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_sleep (int, optional): The initial delay in seconds before attempting to reconnect. Defaults to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_attempt_reconnect</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">start_sleep</span><span class="p">,))</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Attempt reconnect on another thread&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_attempt_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_sleep</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to reconnect to the server.</span>

<span class="sd">        This method attempts to reconnect to the server. If the connection is not successful after 5 attempts, it logs an error message.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_sleep (int, optional): The initial delay in seconds before attempting to reconnect. Defaults to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start_sleep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">start_sleep</span><span class="p">)</span>

        <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_to_server</span><span class="p">()</span> <span class="ow">and</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Waiting for 1 second before retrying</span>
            <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying connection to server (Attempt </span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2">), Port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retry_count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to connect to the server after multiple attempts.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SocketClient.close_server">
<a class="viewcode-back" href="../../../nukebridge.utils.html#nukebridge.utils.soketserver.SocketClient.close_server">[docs]</a>
    <span class="k">def</span> <span class="nf">close_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the server.</span>

<span class="sd">        This method sends a &#39;quit&#39; command to the server to close the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;attempt to close server at port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_obj</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s1">, from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;command::&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;quit&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># Handle error or log it</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">ConnectionResetError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Closing Command sent.&quot;</span><span class="p">)</span></div>
</div>


<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#     # Initialize SocketServer</span>
<span class="c1">#     server = SocketServer(port=5050, data_handler=print_received_data)</span>
<span class="c1">#</span>
<span class="c1">#     # Accept a client connection</span>
<span class="c1">#     server.start_accepting_clients()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Mahmoud Youssef.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>